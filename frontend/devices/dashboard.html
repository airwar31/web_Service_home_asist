<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .widget { background: #2d2d2d; border-radius: 15px; padding: 20px; }
        .widget h3 { margin: 0 0 15px 0; color: #4CAF50; }
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sensor-item { background: #333; padding: 10px; border-radius: 8px; text-align: center; }
        .sensor-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .notification { background: #444; margin: 5px 0; padding: 10px; border-radius: 8px; border-left: 4px solid #ff9800; }
        .notification.high { border-left-color: #f44336; }
        .notification.medium { border-left-color: #ff9800; }
        .notification.low { border-left-color: #4CAF50; }
        .scenario-btn { background: #4CAF50; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 8px; cursor: pointer; }
        .scenario-btn:hover { background: #45a049; }
        .auto-toggle { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .auto-toggle.active { background: #4CAF50; }
        .camera-item { background: #333; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .camera-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .camera-status.connected { background: #4CAF50; }
        .camera-status.disconnected { background: #f44336; }
        .camera-preview { width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: #2d2d2d; margin: 10% auto; padding: 20px; width: 400px; border-radius: 15px; }
        .modal input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #555; background: #333; color: white; border-radius: 5px; }
        .modal button { margin: 10px 5px; }
        .close { float: right; font-size: 28px; cursor: pointer; color: #aaa; }
        .close:hover { color: white; }
    </style>
</head>
<body>
    <h1>üè† –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–º–Ω—ã–º –¥–æ–º–æ–º</h1>
    
    <div class="dashboard">
        <div class="widget">
            <h3>üìä –î–∞—Ç—á–∏–∫–∏</h3>
            <div class="sensor-grid" id="sensorsGrid"></div>
            <button id="autoToggle" class="auto-toggle">–ê–≤—Ç–æ-—Ä–µ–∂–∏–º: –í–ö–õ</button>
        </div>
        
        <div class="widget">
            <h3>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            <div id="notifications"></div>
        </div>
        
        <div class="widget">
            <h3>üé≠ –°—Ü–µ–Ω–∞—Ä–∏–∏</h3>
            <button class="scenario-btn" onclick="activateScenario('—É—Ç—Ä–æ')">üåÖ –£—Ç—Ä–æ</button>
            <button class="scenario-btn" onclick="activateScenario('–≤–µ—á–µ—Ä')">üåÜ –í–µ—á–µ—Ä</button>
            <button class="scenario-btn" onclick="activateScenario('—Å–æ–Ω')">üåô –°–æ–Ω</button>
            <button class="scenario-btn" onclick="activateScenario('—Ä–∞–±–æ—Ç–∞')">üíº –†–∞–±–æ—Ç–∞</button>
        </div>
        
        <div class="widget">
            <h3>üìπ IP –ö–∞–º–µ—Ä—ã</h3>
            <div id="cameras"></div>
            <button onclick="showAddCameraModal()" class="scenario-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
        </div>
        
        <div class="widget">
            <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div id="stats"></div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã -->
    <div id="cameraModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddCameraModal()">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å IP –∫–∞–º–µ—Ä—É</h3>
            <input type="text" id="cameraName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã">
            <input type="text" id="cameraUrl" placeholder="URL –∫–∞–º–µ—Ä—ã (–ø—Ä–∏–º–µ—Ä: 0 –¥–ª—è USB)">            <div style="font-size: 12px; color: #888; margin: 5px 0;">
                –ü—Ä–∏–º–µ—Ä—ã:<br>
                ‚Ä¢ USB –∫–∞–º–µ—Ä–∞: <code>0</code><br>
                ‚Ä¢ IP –∫–∞–º–µ—Ä–∞: <code>rtsp://admin:pass@192.168.1.100:554/stream1</code><br>
                ‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: <code>http://192.168.1.50:8080/video</code>
            </div>
            <label><input type="checkbox" id="motionDetection" checked> –î–µ—Ç–µ–∫—Ü–∏—è —á–µ–ª–æ–≤–µ–∫–∞</label>
            <br><br>
            <button class="scenario-btn" onclick="testCamera()">üîç –¢–µ—Å—Ç</button>
            <button class="scenario-btn" onclick="addCamera()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="auto-toggle" onclick="closeAddCameraModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        function updateSensors() {
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    const grid = document.getElementById('sensorsGrid');
                    grid.innerHTML = '';
                    
                    Object.entries(data).forEach(([key, sensor]) => {
                        const item = document.createElement('div');
                        item.className = 'sensor-item';
                        
                        if (key === 'motion') {
                            item.innerHTML = `<div>–î–≤–∏–∂–µ–Ω–∏–µ</div><div class="sensor-value">${sensor.status ? '–î–ê' : '–ù–ï–¢'}</div>`;
                        } else if (sensor.value !== undefined) {
                            item.innerHTML = `<div>${getSensorName(key)}</div><div class="sensor-value">${sensor.value}${getSensorUnit(key)}</div>`;
                        }
                        
                        grid.appendChild(item);
                    });
                });
        }
        
        function updateNotifications() {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('notifications');
                    container.innerHTML = '';
                    
                    data.slice(0, 5).forEach(notification => {
                        const item = document.createElement('div');
                        item.className = `notification ${notification.priority}`;
                        item.innerHTML = `
                            <div>${notification.message}</div>
                            <small>${new Date(notification.timestamp).toLocaleTimeString()}</small>
                        `;
                        container.appendChild(item);
                    });
                });
        }
        
        function activateScenario(scenario) {
            fetch(`/api/scenarios/${scenario}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.response);
                    }
                });
        }
        
        function toggleAutoMode() {
            fetch('/api/sensors/auto-mode', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    const btn = document.getElementById('autoToggle');
                    btn.textContent = `–ê–≤—Ç–æ-—Ä–µ–∂–∏–º: ${data.auto_mode ? '–í–ö–õ' : '–í–´–ö–õ'}`;
                    btn.className = data.auto_mode ? 'auto-toggle active' : 'auto-toggle';
                });
        }
        
        function updateCameras() {
            fetch('/api/cameras')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('cameras');
                    container.innerHTML = '';
                    
                    Object.entries(data).forEach(([name, camera]) => {
                        const item = document.createElement('div');
                        item.className = 'camera-item';
                        item.innerHTML = `
                            <div>
                                <span class="camera-status ${camera.status}"></span>
                                <strong>${name}</strong>
                                <button onclick="removeCamera('${name}')" style="float: right; background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚úñ</button>
                            </div>
                            <div>–°—Ç–∞—Ç—É—Å: ${getStatusText(camera.status)}</div>
                            <div>–î–µ—Ç–µ–∫—Ü–∏—è —á–µ–ª–æ–≤–µ–∫–∞: ${camera.motion_detection ? '–í–ö–õ' : '–í–´–ö–õ'}</div>
                            ${camera.last_motion ? `<div>–ü–æ—Å–ª–µ–¥–Ω–∏–π —á–µ–ª–æ–≤–µ–∫: ${new Date(camera.last_motion).toLocaleTimeString()}</div>` : ''}
                            ${camera.status === 'connected' ? `<img class="camera-preview" src="/api/cameras/${name}/stream" onerror="this.style.display='none'">` : ''}
                        `;
                        container.appendChild(item);
                    });
                });
        }
        
        function getStatusText(status) {
            const statusMap = {
                'connected': '–ü–æ–¥–∫–ª—é—á–µ–Ω–∞',
                'disconnected': '–û—Ç–∫–ª—é—á–µ–Ω–∞',
                'error': '–û—à–∏–±–∫–∞'
            };
            return statusMap[status] || status;
        }
        
        function showAddCameraModal() {
            document.getElementById('cameraModal').style.display = 'block';
        }
        
        function closeAddCameraModal() {
            document.getElementById('cameraModal').style.display = 'none';
            document.getElementById('cameraName').value = '';
            document.getElementById('cameraUrl').value = '';
        }
        
        function testCamera() {
            const url = document.getElementById('cameraUrl').value;
            if (!url) {
                alert('–í–≤–µ–¥–∏—Ç–µ URL –∫–∞–º–µ—Ä—ã');
                return;
            }
            
            fetch('/api/cameras/test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.success ? '–ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞!' : '–û—à–∏–±–∫–∞: ' + data.error);
            });
        }
        
        function addCamera() {
            const name = document.getElementById('cameraName').value;
            const url = document.getElementById('cameraUrl').value;
            const motionDetection = document.getElementById('motionDetection').checked;
            
            if (!name || !url) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            fetch('/api/cameras/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, url, motion_detection: motionDetection })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeAddCameraModal();
                    updateCameras();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        }
        
        function removeCamera(name) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞–º–µ—Ä—É ${name}?`)) {
                fetch(`/api/cameras/${name}/remove`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            updateCameras();
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + data.error);
                        }
                    });
            }
        }
        
        function getSensorName(key) {
            const names = {
                'light_level': '–û—Å–≤–µ—â–µ–Ω–∏–µ',
                'noise_level': '–®—É–º',
                'air_quality': '–í–æ–∑–¥—É—Ö',
                'humidity': '–í–ª–∞–∂–Ω–æ—Å—Ç—å'
            };
            return names[key] || key;
        }
        
        function getSensorUnit(key) {
            const units = {
                'light_level': '%',
                'noise_level': '–¥–ë',
                'air_quality': '%',
                'humidity': '%'
            };
            return units[key] || '';
        }
        
        document.getElementById('autoToggle').addEventListener('click', toggleAutoMode);
        
        setInterval(() => {
            updateSensors();
            updateNotifications();
            updateCameras();
        }, 2000);
        
        updateSensors();
        updateNotifications();
        updateCameras();
    </script>
</body>
</html>